<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اپلیکیشن جستجوی فیلم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #020617; --bg-light: #f8fafc;
            --card-dark: #0f172a; --card-light: #ffffff;
            --border-dark: #1e293b; --border-light: #e2e8f0;
            --text-dark-primary: #f1f5f9; --text-light-primary: #0f172a;
            --text-dark-secondary: #94a3b8; --text-light-secondary: #64748b;
            --primary-accent: #818cf8; --primary-accent-hover: #6366f1;
        }
        html.dark { --bg-main: var(--bg-dark); --bg-card: var(--card-dark); --border-main: var(--border-dark); --text-primary: var(--text-dark-primary); --text-secondary: var(--text-dark-secondary); }
        html:not(.dark) { --bg-main: var(--bg-light); --bg-card: var(--card-light); --border-main: var(--border-light); --text-primary: var(--text-light-primary); --text-secondary: var(--text-light-secondary); }
        
        html { scroll-behavior: smooth; }
        body { font-family: 'Vazirmatn', 'Noto Sans SC', 'Roboto', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .card, .modal-glass, .filter-btn, .pagination-btn, #searchInput, .sort-select, #language-select { background-color: var(--bg-card); border-color: var(--border-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .filter-btn { color: var(--text-secondary); }
        html:not(.dark) .filter-btn:hover { background-color: #e2e8f0; }
        html.dark .filter-btn:hover { background-color: #334155; }
        .filter-btn.active { background-color: var(--primary-accent); color: white; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-card); }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); border-radius: 10px; }
        
        .gradient-text { background: linear-gradient(90deg, #a78bfa, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-glass, .notification-glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 4px solid var(--border-main); border-top-color: var(--primary-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        
        .skeleton-card { background-color: var(--bg-card); border-radius: 0.5rem; overflow: hidden; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton-img { width: 100%; background-color: var(--border-main); aspect-ratio: 2/3; }

        /* Hero Carousel */
        .hero-slide { display: none; animation: fadeIn 1.5s; }
        .hero-slide.active { display: block; }

        /* Star Rating */
        .star-rating { display: inline-flex; direction: ltr; }
        .star-rating svg { color: #e2e8f0; }
        .star-rating svg.filled { color: #facc15; }

        /* Language-specific styles */
        html[lang="en"], html[lang="zh"] { direction: ltr; }
        html[lang="en"] body { font-family: 'Roboto', sans-serif; }
        html[lang="zh"] body { font-family: 'Noto Sans SC', sans-serif; }
        html[lang="fa"] body { font-family: 'Vazirmatn', sans-serif; }
    </style>
</head>
<body class="dark">

    <!-- Welcome Notification -->
    <div id="welcome-notification" class="hidden fixed top-5 right-1/2 w-full max-w-md p-4 z-[100] transition-transform duration-500 ease-in-out" style="transform: translate(50%, -150%);">
        <div class="notification-glass bg-slate-800/70 border border-slate-700 shadow-2xl rounded-xl p-4 flex items-center gap-4">
            <div class="flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                </svg>
            </div>
            <div class="flex-grow">
                <h3 id="welcome-title" class="text-lg font-bold text-slate-100">به سینماتِک خوش آمدید</h3>
                <p id="welcome-text" class="text-slate-300 text-sm">جدیدترین فیلم‌ها و سریال‌ها در دستان شماست!</p>
            </div>
            <button id="close-notification" class="text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <nav class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <h1 id="app-title" class="text-2xl md:text-3xl font-extrabold gradient-text">سینماتِک</h1>
            <div class="flex items-center gap-4">
                <select id="language-select" class="appearance-none pr-8 pl-4 py-2 border rounded-full bg-[var(--bg-card)] text-[var(--text-primary)]">
                    <option value="fa">فارسی</option>
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                </select>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </nav>

        <section id="hero-carousel" class="relative rounded-xl overflow-hidden mb-10 h-96 w-full">
            <!-- Hero slides will be injected here -->
        </section>

        <header class="text-center mb-8">
            <form id="searchForm" class="max-w-2xl mx-auto">
                 <div class="relative">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </span>
                    <input type="text" id="searchInput" class="w-full border-2 rounded-full py-3 pr-12 pl-32 focus:outline-none focus:border-indigo-500" placeholder="جستجوی فیلم...">
                    <button type="button" id="clearSearchBtn" class="absolute left-28 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button type="submit" id="search-btn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-indigo-600 text-white rounded-full px-6 py-2 hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105">
                        یافتن
                    </button>
                </div>
            </form>
        </header>

        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div id="filter-buttons" class="flex flex-wrap justify-center gap-2 md:gap-3">
                <button data-endpoint="/api/movies/new" class="filter-btn">فیلم‌های جدید</button>
                <button data-endpoint="/api/movies/top-rated" class="filter-btn">فیلم‌های برتر</button>
                <button data-endpoint="favorites" class="filter-btn flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    علاقه‌مندی‌ها
                </button>
            </div>
            <div class="relative">
                 <select id="sort-select" class="sort-select appearance-none pr-8 pl-4 py-2 border rounded-full">
                    <option value="default">مرتب‌سازی</option>
                    <option value="rating_desc">بالاترین امتیاز</option>
                    <option value="rating_asc">پایین‌ترین امتیاز</option>
                    <option value="year_desc">جدیدترین</option>
                    <option value="year_asc">قدیمی‌ترین</option>
                </select>
            </div>
        </div>
        
        <main id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></main>

        <div id="message" class="text-center my-8"></div>

        <div id="pagination" class="text-center my-8">
             <button id="load-more-btn" class="bg-indigo-600 text-white rounded-full px-8 py-3 hover:bg-indigo-700 transition-colors hidden">بارگذاری بیشتر</button>
        </div>
    </div>

    <footer class="border-t border-indigo-500/20 mt-12 py-8 bg-slate-900/20">
        <div class="container mx-auto px-4 md:px-8 text-center text-slate-400">
            <div class="mb-4">
                <p class="text-lg">
                    <span id="footer-developed">طراحی و توسعه با <span class="text-red-500 animate-pulse">❤️</span> توسط </span>
                    <a id="developer-link" href="https://www.instagram.com/hamidyaraliofficial?igsh=MWpxZjhhMHZuNnlpYQ==" target="_blank" rel="noopener noreferrer" class="font-bold text-indigo-400 hover:text-indigo-300 transition-colors tracking-wider">حمید یارعلی</a>
                </p>
            </div>
            <div class="flex justify-center items-center gap-6 mb-4">
                <a id="instagram-link" href="https://www.instagram.com/hamidyaraliofficial?igsh=MWpxZjhhMHZuNnlpYQ==" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.366.062 2.633.336 3.608 1.311.975.975 1.249 2.242 1.311 3.608.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.062 1.366-.336 2.633-1.311 3.608-.975.975-2.242 1.249-3.608 1.311-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.366-.062-2.633-.336-3.608-1.311-.975-.975-1.249-2.242-1.311-3.608-.058-1.266-.07-1.646-.07-4.85s.012-3.584.07-4.85c.062-1.366.336-2.633 1.311-3.608.975-.975 2.242-1.249 3.608-1.311 1.266-.058 1.646-.07 4.85-.07m0-2.163c-3.259 0-3.667.014-4.947.072-1.468.066-2.992.377-4.126 1.51-1.133 1.134-1.444 2.658-1.51 4.126-.058 1.28-.072 1.688-.072 4.947s.014 3.667.072 4.947c.066 1.468.377 2.992 1.51 4.126 1.134 1.133 2.658 1.444 4.126 1.51 1.28.058 1.688.072 4.947.072s3.667-.014 4.947-.072c1.468-.066 2.992-.377 4.126-1.51 1.133-1.134 1.444-2.658 1.51-4.126.058-1.28.072-1.688.072-4.947s-.014-3.667-.072-4.947c-.066-1.468-.377-2.992-1.51-4.126-1.134-1.133-2.658-1.444-4.126-1.51-1.28-.058-1.688-.072-4.947-.072zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.441s.645 1.441 1.441 1.441 1.441-.645 1.441-1.441-.645-1.441-1.441-1.441z"/></svg>
                    <span id="instagram-name">صفحه اینستاگرام</span>
                </a>
                <div class="border-l h-5 border-slate-600"></div>
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.25 2.5a.75.75 0 00-1.5 0v.063c-2.433.32-4.48 2.368-4.75 4.813-.03.26.18.49.44.52A.47.47 0 005 7.81v-.01a5.5 5.5 0 019.98 1.74 1 1 0 001.73-1A7.5 7.5 0 008.75 2.563V2.5zM15.5 10.25a.75.75 0 00-1.5 0v.063c-2.433.32-4.48 2.368-4.75 4.813-.03.26.18.49.44.52a.47.47 0 00.56-.41v-.01a5.5 5.5 0 019.98 1.74 1 1 0 001.73-1A7.5 7.5 0 0013.25 10.813V10.25z" />
                    </svg>
                    <span id="footer-version">نسخه 1.0</span>
                </div>
            </div>
            <p id="footer-copyright" class="text-xs text-slate-500">&copy; 2024 سینماتِک. تمام حقوق محفوظ است.</p>
        </div>
    </footer>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 fade-in">
        <div id="modal-content" class="modal-glass rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto relative card"></div>
    </div>

    <button id="backToTopBtn" class="hidden fixed bottom-5 left-5 bg-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
    </button>

    <script>
        // --- Language Translations ---
        const translations = {
            fa: {
                appTitle: "سینماتِک",
                welcomeTitle: "به سینماتِک خوش آمدید",
                welcomeText: "جدیدترین فیلم‌ها و سریال‌ها در دستان شماست!",
                searchPlaceholder: "جستجوی فیلم...",
                searchBtn: "یافتن",
                newMovies: "فیلم‌های جدید",
                topRated: "فیلم‌های برتر",
                favorites: "علاقه‌مندی‌ها",
                sortDefault: "مرتب‌سازی",
                sortRatingDesc: "بالاترین امتیاز",
                sortRatingAsc: "پایین‌ترین امتیاز",
                sortYearDesc: "جدیدترین",
                sortYearAsc: "قدیمی‌ترین",
                loadMore: "بارگذاری بیشتر",
                noFavorites: "هنوز فیلمی به علاقه‌مندی‌ها اضافه نکرده‌اید.",
                noResults: "موردی یافت نشد.",
                serverError: "خطا در ارتباط با سرور.",
                footerDeveloped: "طراحی و توسعه با <span class='text-red-500 animate-pulse'>❤️</span> توسط ",
                footerVersion: "نسخه 1.0",
                footerCopyright: "&copy; 2024 سینماتِک. تمام حقوق محفوظ است.",
                modalPlot: "خلاصه داستان",
                modalDownload: "دانلود",
                modalNoLinks: "لینکی برای این مورد یافت نشد.",
                moreDetails: "جزئیات بیشتر",
                instagramName: "صفحه اینستاگرام"
            },
            en: {
                appTitle: "Cinematek",
                welcomeTitle: "Welcome to Cinematek",
                welcomeText: "The latest movies and series at your fingertips!",
                searchPlaceholder: "Search for movies...",
                searchBtn: "Find",
                newMovies: "New Movies",
                topRated: "Top Rated",
                favorites: "Favorites",
                sortDefault: "Sort",
                sortRatingDesc: "Highest Rating",
                sortRatingAsc: "Lowest Rating",
                sortYearDesc: "Newest",
                sortYearAsc: "Oldest",
                loadMore: "Load More",
                noFavorites: "You haven't added any movies to your favorites yet.",
                noResults: "No results found.",
                serverError: "Error connecting to the server.",
                footerDeveloped: "Designed and developed with <span class='text-red-500 animate-pulse'>❤️</span> by ",
                footerVersion: "Version 1.0",
                footerCopyright: "&copy; 2024 Cinematek. All rights reserved.",
                modalPlot: "Plot Summary",
                modalDownload: "Download",
                modalNoLinks: "No links found for this item.",
                moreDetails: "More Details",
                instagramName: "Instagram Page"
            },
            zh: {
                appTitle: "电影天堂",
                welcomeTitle: "欢迎体验电影天堂",
                welcomeText: "最新电影和剧集尽在掌握！",
                searchPlaceholder: "搜索电影...",
                searchBtn: "查找",
                newMovies: "新电影",
                topRated: "高评分",
                favorites: "收藏",
                sortDefault: "排序",
                sortRatingDesc: "最高评分",
                sortRatingAsc: "最低评分",
                sortYearDesc: "最新",
                sortYearAsc: "最旧",
                loadMore: "加载更多",
                noFavorites: "您尚未将任何电影添加到收藏。",
                noResults: "未找到任何结果。",
                serverError: "连接服务器时出错。",
                footerDeveloped: "由 <span class='text-red-500 animate-pulse'>❤️</span> 设计与开发 ",
                footerVersion: "版本 1.0",
                footerCopyright: "&copy; 2024 电影天堂。保留所有权利。",
                modalPlot: "剧情简介",
                modalDownload: "下载",
                modalNoLinks: "未找到此项目的链接。",
                moreDetails: "更多详情",
                instagramName: "Instagram页面"
            }
        };

        // --- Constants and DOM Elements ---
        const API_BASE_URL = 'https://cinemaplus-app.vercel.app';
        const elements = {
            html: document.documentElement,
            themeToggle: document.getElementById('theme-toggle'),
            themeIconLight: document.getElementById('theme-icon-light'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            heroCarousel: document.getElementById('hero-carousel'),
            searchForm: document.getElementById('searchForm'),
            searchInput: document.getElementById('searchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            searchBtn: document.getElementById('search-btn'),
            resultsGrid: document.getElementById('resultsGrid'),
            messageDiv: document.getElementById('message'),
            pagination: document.getElementById('pagination'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            filterButtons: document.querySelectorAll('.filter-btn'),
            sortSelect: document.getElementById('sort-select'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modal-content'),
            backToTopBtn: document.getElementById('backToTopBtn'),
            welcomeNotification: document.getElementById('welcome-notification'),
            languageSelect: document.getElementById('language-select'),
            appTitle: document.getElementById('app-title'),
            welcomeTitle: document.getElementById('welcome-title'),
            welcomeText: document.getElementById('welcome-text'),
            footerDeveloped: document.getElementById('footer-developed'),
            footerVersion: document.getElementById('footer-version'),
            footerCopyright: document.getElementById('footer-copyright'),
            instagramName: document.getElementById('instagram-name')
        };
        
        // --- State Management ---
        let state = {
            currentPage: 1,
            currentEndpoint: '/api/movies/new',
            currentSearchQuery: '',
            isLoading: false,
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            allResults: [],
            currentLanguage: 'fa'
        };

        // --- Language Handling ---
        function applyLanguage(lang) {
            state.currentLanguage = lang;
            elements.html.setAttribute('lang', lang);
            elements.html.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');
            localStorage.setItem('language', lang);
            const t = translations[lang];

            // Update static UI elements
            elements.appTitle.textContent = t.appTitle;
            elements.welcomeTitle.textContent = t.welcomeTitle;
            elements.welcomeText.textContent = t.welcomeText;
            elements.searchInput.placeholder = t.searchPlaceholder;
            elements.searchBtn.textContent = t.searchBtn;
            elements.loadMoreBtn.textContent = t.loadMore;
            elements.footerDeveloped.innerHTML = t.footerDeveloped;
            elements.footerVersion.textContent = t.footerVersion;
            elements.footerCopyright.innerHTML = t.footerCopyright;
            elements.instagramName.textContent = t.instagramName;

            // Update filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons[0].textContent = t.newMovies;
            filterButtons[1].textContent = t.topRated;
            filterButtons[2].innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>${t.favorites}`;

            // Update sort select options
            const sortOptions = elements.sortSelect.options;
            sortOptions[0].text = t.sortDefault;
            sortOptions[1].text = t.sortRatingDesc;
            sortOptions[2].text = t.sortRatingAsc;
            sortOptions[3].text = t.sortYearDesc;
            sortOptions[4].text = t.sortYearAsc;

            // Refresh results to update modal translations
            displayResults(state.allResults);
            setupHeroCarousel();
        }

        // --- API & Data Handling ---
        async function fetchData(loadMore = false) {
            if (state.isLoading) return;
            state.isLoading = true;
            elements.messageDiv.innerHTML = '';
            if (!loadMore) {
                displaySkeletons(12);
                state.allResults = [];
            }
            elements.loadMoreBtn.classList.add('hidden');

            try {
                let results = [];
                if (state.currentEndpoint === 'favorites') {
                    results = state.favorites;
                } else {
                    const url = state.currentSearchQuery 
                        ? `${API_BASE_URL}/api/search?q=${state.currentSearchQuery}`
                        : `${API_BASE_URL}${state.currentEndpoint}?page=${state.currentPage - 1}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Network response was not ok`);
                    const data = await response.json();
                    results = data.posters || data.search_results || data;
                }
                
                if (!loadMore) elements.resultsGrid.innerHTML = '';
                
                if (results && results.length > 0) {
                    state.allResults.push(...results);
                    displayResults(state.allResults);
                    if (state.currentEndpoint !== 'favorites' && !state.currentSearchQuery && results.length > 0) {
                        elements.loadMoreBtn.classList.remove('hidden');
                    }
                } else {
                    if (!loadMore) {
                         showMessage(state.currentEndpoint === 'favorites' ? translations[state.currentLanguage].noFavorites : translations[state.currentLanguage].noResults);
                    }
                    elements.loadMoreBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                if (!loadMore) showMessage(translations[state.currentLanguage].serverError);
            } finally {
                state.isLoading = false;
                sortResults();
            }
        }
        
        // --- Description Parser ---
        function parseDescription(description) {
            const details = {};
            if (!description) return details;
            const patterns = {
                plot: /خلاصه (?:داستان|فیلم)\s*:\s*([\s\S]*?)(?:درباره فیلم:|زیرنویس چسبیده|$)/,
                director: /کارگردان\s*:\s*(.*)/,
                stars: /ستارگان\s*:\s*([\s\S]*?)(?:\r\n\r\n|\n\n|خلاصه داستان)/,
            };
            for (const key in patterns) {
                const match = description.match(patterns[key]);
                if (match && match[1]) {
                    details[key] = match[1].trim().replace(/\s{2,}/g, ' ');
                }
            }
            return details;
        }

        // --- UI Rendering ---
        function displaySkeletons(count) {
            elements.resultsGrid.innerHTML = Array(count).fill('').map(() => `<div class="skeleton-card"><div class="skeleton-img"></div></div>`).join('');
        }

        function displayResults(items) {
            elements.resultsGrid.innerHTML = '';
            items.forEach((item, index) => {
                const isFav = isFavorite(item.id);
                const card = document.createElement('div');
                card.className = 'card rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer group';
                card.dataset.id = item.id;
                card.dataset.rating = item.imdb || 0;
                card.dataset.year = item.year || 0;
                card.innerHTML = `
                    <div class="relative">
                        <img src="${item.image}" alt="${item.title}" class="w-full h-auto object-cover aspect-[2/3]" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1e293b/6366f1?text=بدون+پوستر';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-3">
                            <h3 class="text-white text-base font-bold">${item.title}</h3>
                            <div class="flex justify-between items-center mt-2">
                                ${getStarRating(item.imdb)}
                                <button class="favorite-btn p-1 bg-black/40 rounded-full" data-item-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="${isFav ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.favorite-btn')) {
                        showItemDetails(item);
                    }
                });
                elements.resultsGrid.appendChild(card);
            });
        }
        
        async function showItemDetails(item) {
            elements.modal.classList.remove('hidden');
            elements.modalContent.innerHTML = `<div class="flex justify-center items-center p-20"><div class="loader"></div></div>`;
            const isFav = isFavorite(item.id);
            const details = parseDescription(item.description);
            const t = translations[state.currentLanguage];

            const downloadsHTML = (item.sources && item.sources.length > 0)
                ? `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-4">` + item.sources.map(s => s.url ? `<a href="${s.url}" target="_blank" rel="noopener noreferrer" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm text-center flex items-center justify-center gap-2"><span>${s.quality || 'دانلود'} ${s.type ? `(${s.type})` : ''}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></a>` : '').join('') + `</div>`
                : `<p class="text-slate-400 p-4">${t.modalNoLinks}</p>`;

            elements.modalContent.innerHTML = `
                <button id="closeModalInner" class="absolute top-3 left-3 text-slate-300 hover:text-white bg-black/20 rounded-full w-8 h-8 flex items-center justify-center z-10">&times;</button>
                <div class="md:flex gap-8 p-5 md:p-8">
                    <div class="md:w-1/3 text-center mb-4 md:mb-0 flex-shrink-0">
                        <img src="${item.image}" alt="${item.title}" class="rounded-lg shadow-xl mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1e293b/6366f1?text=بدون+پوستر';">
                    </div>
                    <div class="md:w-2/3">
                        <div class="flex justify-between items-start">
                             <h2 class="text-3xl font-bold gradient-text mb-2">${item.title} (${item.year || 'N/A'})</h2>
                             <button class="favorite-btn p-2" data-item-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="${isFav ? 'var(--primary-accent)' : 'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                            </button>
                        </div>
                        ${item.imdb ? `<p class="text-amber-400 font-bold mb-4">IMDb Rating: ${item.imdb}</p>` : ''}
                        <h3 class="text-xl font-semibold border-b-2 border-indigo-500 pb-1 my-4">${t.modalPlot}</h3>
                        <p class="leading-relaxed mb-4 text-sm">${details.plot || 'Not available.'}</p>
                        <h4 class="text-xl font-bold mt-6 mb-3 text-indigo-400">${t.modalDownload}</h4>
                        <div class="bg-slate-200 dark:bg-slate-800/50 rounded-lg overflow-hidden">${downloadsHTML}</div>
                    </div>
                </div>
            `;
            document.getElementById('closeModalInner').addEventListener('click', () => elements.modal.classList.add('hidden'));
        }

        // --- Favorites Logic ---
        function isFavorite(id) { return state.favorites.some(fav => fav.id === id); }
        function toggleFavorite(item) {
            const itemId = item.id;
            const favIndex = state.favorites.findIndex(fav => fav.id === itemId);
            if (favIndex > -1) {
                state.favorites.splice(favIndex, 1);
            } else {
                state.favorites.push(item);
            }
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            updateFavoriteIcons(itemId);
            if (state.currentEndpoint === 'favorites') fetchData();
        }
        function updateFavoriteIcons(itemId) {
            const isFav = isFavorite(itemId);
            document.querySelectorAll(`.favorite-btn[data-item-id="${itemId}"] svg`).forEach(svg => {
                svg.setAttribute('fill', isFav ? 'currentColor' : 'none');
                if (svg.closest('.modal-glass')) svg.setAttribute('fill', isFav ? 'var(--primary-accent)' : 'none');
            });
        }

        // --- Sorting Logic ---
        function sortResults() {
            const sortBy = elements.sortSelect.value;
            if (sortBy === 'default') return;
            state.allResults.sort((a, b) => {
                const key = sortBy.split('_')[0] === 'rating' ? 'imdb' : 'year';
                const valA = parseFloat(a[key] || 0);
                const valB = parseFloat(b[key] || 0);
                return sortBy.endsWith('_asc') ? valA - valB : valB - valA;
            });
            displayResults(state.allResults);
        }

        // --- Hero Carousel ---
        let currentSlide = 0;
        let slideInterval;
        async function setupHeroCarousel() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/movies/top-rated`);
                const data = await response.json();
                const topMoviesData = data.posters || data.search_results || data;
                if (!topMoviesData || !Array.isArray(topMoviesData)) {
                    console.error("Hero carousel data is not a valid array:", topMoviesData);
                    elements.heroCarousel.style.display = 'none';
                    return;
                }
                const topMovies = topMoviesData.slice(0, 5);
                if (topMovies && topMovies.length > 0) {
                    elements.heroCarousel.innerHTML = topMovies.map((movie, index) => {
                        const heroDetails = parseDescription(movie.description);
                        return `
                        <div class="hero-slide absolute inset-0 w-full h-full ${index === 0 ? 'active' : ''}">
                            <img src="${movie.image}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                            <div class="absolute bottom-0 p-8 text-white">
                                <h2 class="text-4xl font-bold">${movie.title}</h2>
                                <p class="mt-2 max-w-2xl line-clamp-3">${heroDetails.plot || ''}</p>
                                <button class="mt-4 bg-indigo-600 text-white rounded-full px-6 py-2 hover:bg-indigo-700 transition-colors" onclick='showItemDetails(${JSON.stringify(movie)})'>${translations[state.currentLanguage].moreDetails}</button>
                            </div>
                        </div>`;
                    }).join('');
                    
                    const slides = document.querySelectorAll('.hero-slide');
                    function showSlide(index) {
                        slides.forEach((slide, i) => {
                            slide.classList.toggle('active', i === index);
                        });
                    }
                    
                    clearInterval(slideInterval);
                    slideInterval = setInterval(() => {
                        currentSlide = (currentSlide + 1) % slides.length;
                        showSlide(currentSlide);
                    }, 5000);
                }
            } catch (error) { console.error("Failed to update hero:", error); }
        }

        // --- Theme Logic ---
        function applyTheme(theme) {
            elements.html.classList.toggle('dark', theme === 'dark');
            elements.themeIconLight.style.display = theme === 'dark' ? 'block' : 'none';
            elements.themeIconDark.style.display = theme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', theme);
        }

        // --- Star Rating ---
        function getStarRating(rating) {
            const score = parseFloat(rating) / 2;
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                const isFilled = i <= score;
                const isHalf = i - 0.5 <= score && i > score;
                stars += `<svg class="w-4 h-4 ${isFilled ? 'filled' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="${isHalf ? 'M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z M10 12.422l-3.629 1.907.692-4.032-2.93-2.856 4.048-.588L10 3.333l1.818 3.618 4.048.588-2.93 2.856.692 4.032L10 12.422z' : 'M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z'}"/></svg>`;
            }
            return `<div class="star-rating">${stars}</div>`;
        }
        
        // --- Welcome Notification Logic ---
        function showWelcomeNotification() {
            if (sessionStorage.getItem('welcomeShown')) return;

            const notification = elements.welcomeNotification;
            const closeBtn = document.getElementById('close-notification');

            const hideNotification = () => {
                notification.style.transform = 'translate(50%, -150%)';
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 500);
            };

            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.style.transform = 'translate(50%, 0)';
            }, 100);

            const autoHideTimeout = setTimeout(hideNotification, 5000);

            closeBtn.addEventListener('click', () => {
                clearTimeout(autoHideTimeout);
                hideNotification();
            }, { once: true });

            sessionStorage.setItem('welcomeShown', 'true');
        }

        // --- Footer Setup ---
        function setupFooterInfo() {
            const devLink = document.getElementById('developer-link');
            const instagramLink = document.getElementById('instagram-link');
            const instagramName = document.getElementById('instagram-name');

            if (devLink) {
                devLink.href = 'https://www.instagram.com/hamidyaraliofficial?igsh=MWpxZjhhMHZuNnlpYQ==';
                devLink.textContent = 'حمید یارعلی';
            }

            if (instagramLink && instagramName) {
                instagramLink.href = 'https://www.instagram.com/hamidyaraliofficial?igsh=MWpxZjhhMHZuNnlpYQ==';
                instagramName.textContent = translations[state.currentLanguage].instagramName;
            }
        }

        // --- UI Updates & Event Listeners ---
        function showMessage(msg) { elements.messageDiv.innerHTML = `<p class="p-4 bg-red-500/10 text-red-500 rounded-lg">${msg}</p>`; }
        function setupEventListeners() {
            elements.searchForm.addEventListener('submit', e => { e.preventDefault(); state.currentPage = 1; state.currentSearchQuery = elements.searchInput.value.trim(); state.currentEndpoint = ''; applyButtonStyles(); fetchData(); });
            elements.searchInput.addEventListener('input', () => { elements.clearSearchBtn.classList.toggle('hidden', !elements.searchInput.value); });
            elements.clearSearchBtn.addEventListener('click', () => { elements.searchInput.value = ''; elements.clearSearchBtn.classList.add('hidden'); state.currentSearchQuery = ''; state.currentPage = 1; state.currentEndpoint = '/api/movies/new'; applyButtonStyles(); fetchData(); });
            elements.filterButtons.forEach(button => { button.addEventListener('click', () => { state.currentEndpoint = button.dataset.endpoint; state.currentPage = 1; state.currentSearchQuery = ''; elements.searchInput.value = ''; applyButtonStyles(); fetchData(); }); });
            elements.sortSelect.addEventListener('change', sortResults);
            elements.loadMoreBtn.addEventListener('click', () => { state.currentPage++; fetchData(true); });
            elements.resultsGrid.addEventListener('click', e => { if (e.target.closest('.favorite-btn')) { const btn = e.target.closest('.favorite-btn'); const card = btn.closest('.card'); const item = { id: parseInt(card.dataset.id), title: card.querySelector('h3').textContent, image: card.querySelector('img').src, imdb: card.dataset.rating, year: card.dataset.year, description: "برای نمایش جزئیات کلیک کنید" }; toggleFavorite(item); } });
            elements.modalContent.addEventListener('click', e => { if (e.target.closest('.favorite-btn')) { const btn = e.target.closest('.favorite-btn'); const itemId = parseInt(btn.dataset.itemId); const item = state.allResults.find(m => m.id === itemId) || state.favorites.find(f => f.id === itemId); if(item) toggleFavorite(item); } });
            elements.modal.addEventListener('click', e => { if (e.target === elements.modal) elements.modal.classList.add('hidden'); });
            window.addEventListener('scroll', () => { elements.backToTopBtn.classList.toggle('hidden', window.scrollY < 300); });
            elements.backToTopBtn.addEventListener('click', () => window.scrollTo(0, 0));
            elements.themeToggle.addEventListener('click', () => { const newTheme = elements.html.classList.contains('dark') ? 'light' : 'dark'; applyTheme(newTheme); });
            elements.languageSelect.addEventListener('change', () => applyLanguage(elements.languageSelect.value));
        }
        function applyButtonStyles() { elements.filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.endpoint === state.currentEndpoint)); }
        
        // --- Initialization ---
        function initialize() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedLanguage = localStorage.getItem('language') || 'fa';
            applyTheme(savedTheme);
            applyLanguage(savedLanguage);
            elements.languageSelect.value = savedLanguage;
            setupEventListeners();
            applyButtonStyles();
            setupHeroCarousel();
            fetchData();
            showWelcomeNotification();
            setupFooterInfo();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>